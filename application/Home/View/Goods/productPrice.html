<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>新增产品报价</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="__PUBLIC__/css/layui/css/layui.css"  media="all">
  <link rel="stylesheet" href="__PUBLIC__/css/amazeui.min.css" />
  <link rel="stylesheet" href="__PUBLIC__/css/admin.css">
  <link rel="stylesheet" href="__PUBLIC__/css/app.css" />
  <style>
      .layui-form-item {
        margin: 0;
      }
      .layui-form-label { width: 120px; }
  </style>
</head>
<body class="abc">
    <!-- 网站头部 -->
    <header class="am-topbar am-topbar-inverse admin-header">
        <include file="Public:header"/>
    </header>
    <div class="tpl-page-container tpl-page-header-fixed">
        <!-- 左侧菜单栏 -->
        <div class="tpl-left-nav tpl-left-nav-hover xg-left-nav-3" nav="goodsPrice">
            <include file="Public:menu"/>
        </div>
        <!-- 右侧主要内容 -->
        <div class="tpl-content-wrapper">
            <ol class="am-breadcrumb" style="margin: 5px">
                <li><a href="__APP__/Index" class="am-icon-home">首页</a></li>
                <li class="am-active">新增产品报价</li>
            </ol>
            <div class="layui-row" style="background: #fff;">
                <form class="layui-form" action="">
                    <div class="layui-form-item" style="padding-top: 20px">
                        <div class="layui-inline" style="margin-top:10px;margin-left:50px;">
                            <label class="layui-form-label">商品分类</label> 
                            <div class="layui-input-inline" style="width:200px;margin-left:50px;float: left;">
                                <select id="product_type" name="product_type" lay-search="" lay-filter="changeProductTypeInfo" >
                                    <option value="" checked="checked">全部分类</option>
                                    <foreach name="productTypeInfo" item="v">
                                       <option value="{$v['id']}" >{$v['type_name']}</option>
                                    </foreach>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline" style="margin-top:5px;margin-left:50px;">
                            <label class="layui-form-label">商品名称:</label>
                            <div class="layui-input-inline" style="width:200px;margin-left:50px;float: left;">
                                <select id="product" name="product" lay-verify="required" lay-search="" lay-filter="changeProduct">
                                    <option value="">直接选择或搜索选择</option>
                                    <foreach name="productInfo" item="v">
                                            <option value="{$v['id']}" >{$v['type_name']}</option>
                                    </foreach>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div id="model" class="layui-form-item" style="margin-top:5px;margin-left:50px;">
                        <label class="layui-form-label" style="margin-right:50px;">商品型号:</label>
                        <div class="layui-input-block" id="product_model">
                            <!-- <input type="radio" name="sex" value="男" title="男" checked="">
                            <input type="radio" name="sex" value="女" title="女"> -->
                            <!-- <foreach name="productModelInfo" item="v">
                                <input type="radio"  lay-filter="productModelRadio" name="product_model" value="{$v['id']}" title="{$v['name']}">
                            </foreach> -->
                            <span id="sname_notice" style="color:#FF0000;font-size:16px;"> 请先选择商品分类和商品名称</span> 
                        </div>

                    </div>
                    

                    <div id="product_parameter" class="layui-form-item product_parameter" style="margin-top:10px;margin-left:50px;">
                        <label class="layui-form-label" style="margin-right:50px;">商品规格:</label>
                        <div class="layui-input-block" id="product_spec">
                            <span id="sname_notice" style="color:#FF0000;font-size:16px;"> 请先选择商品名称和商品型号</span> 
                        </div>
                    </div>
                    <div id="supplier" class="layui-form-item" style="margin-left:50px;">
                        <label class="layui-form-label" style="margin-right:50px;">供应商:</label>
                        <div class="layui-input-block" id="product_supplier">
                            <span id="sname_notice" style="color:#FF0000;font-size:16px;"> 请先选择商品</span> 
                        </div>
                    </div>
                    <div id="product_price" lay-filter="product_price" class="layui-form-item" style="margin-top:20px;margin-left:50px;">
                        <label class="layui-form-label" style="margin-right:50px;">商品价格:</label>
                        <div class="layui-input-block" >
                            <input type="text" id="price" lay-filter="price" name="price" autocomplete="off"  lay-verify="number" placeholder="请输入价格" class="layui-input" style="width:200px;margin-left:50px;">
                        </div>
                    </div>
                    <div id="hidden" class="layui-form-item">
                        <div class="layui-input-block" id="parameter_hidden">
                            <!-- <input type="hidden" id="parameter_id" name="parameter_id" value="" > -->
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <button type="button" class="layui-btn layui-btn-warm" style="margin-top: 10px;margin-left: 300px;" onClick='addProductPrice()'>确认添加</button> 
                            </div>
                        </div>
                    </div>

                </form>

            </div>

        </div>
    </div>
            
          
<script src="__PUBLIC__/css/layui/layui.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script src="__PUBLIC__/js/jquery.min.js"></script>
<script src="__PUBLIC__/js/amazeui.min.js"></script>
<script src="__PUBLIC__/js/app.js"></script>
<script src="__PUBLIC__/js/plus.js"></script>
<!-- <script src="__PUBLIC__/js/jquery-editable-select.js"></script> -->

<script>
layui.use(['form', 'layedit', 'laydate'], function(){
    var form = layui.form
    ,layer = layui.layer
    ,layedit = layui.layedit
    ,laydate = layui.laydate;
  
    //产品分类选择
    form.on('select(changeProductTypeInfo)', function(data){

        var type_id = $("#product_type").val();
        if(type_id == '0'){
            var type_id = 0;
        }else{
            var type_id = type_id;
        }
          
        $.ajax({
            url:'__APP__/Goods/getProductNames',
            data:'type_id='+type_id,
            type:'post',
            dataType:'json',
            success:function(re){
                var product_id = '';
                var product_name = '';

                $("#product").empty();
                $("#product").append("<option value=''>直接选择或搜索选择</option>"); 
                for (var k in re){
                    product_id = re[k].id;
                    product_name = re[k].type_name;
                    $("#product").append("<option value='"+product_id+"'>"+product_name+"</option>"); 
                }
                
                layui.form.render('select');
            }
        });
    });

    //选择产品名称时重新加载商品型号
    form.on('select(changeProduct)', function(data){
        var id = $("#product").val();
        //重新渲染隐藏域中商品规格名称ID串的值
        $("#parameter_hidden").empty();
        //重新渲染商品型号下拉选择框的内容
        $.ajax({
            url:'__APP__/Goods/getProductModel',
            data:'id='+id,
            type:'post',
            dataType:'json',
            success:function(re){
                var product_id = '';
                var product_name = '';

                $("#product_model").empty();
                if(re){
                    for (var k in re){
                        product_id = re[k].id;
                        product_name = re[k].name;
                        
                        var html = "<input type='radio' lay-filter='productModelRadio' name='product_model' value='"+product_id+"' title='"+product_name+"' >";
                        
                        $("#product_model").append(html);
                    }
                    layui.form.render('radio')

                    $("#model~#product_parameter").remove();
                    var null_html = "<div id='product_parameter' class='layui-form-item' style='margin-left:50px;'> <label class='layui-form-label' style='margin-right:50px;'>商品规格:</label><div class='layui-input-block' id='product_spec' lay-filter='product_spec' > <span id='sname_notice' style='color:#FF0000;font-size:16px;'> 请先选择商品名称和商品型号！</span>  </div> </div> ";
                    $("#model").after(null_html);

                }else{
                    $("#product_model").append("<span id='sname_notice' style='color:#FF0000;font-size:16px;'> 暂无商品型号！</span>");

                    //重新加载商品规格信息
                    $("#model~#product_parameter").remove();
                    var null_html = "<div id='product_parameter' class='layui-form-item' style='margin-top:40px;margin-left:50px;'> <label class='layui-form-label' style='margin-right:50px;'>商品规格:</label><div class='layui-input-block' id='product_spec' lay-filter='product_spec' > <span id='sname_notice' style='color:#FF0000;font-size:16px;'> 暂无商品规格信息！</span>  </div> </div> ";
                    
                    $("#model").after(null_html);
                }
            }
        });

        //重新渲染商品对应的供应商
        $.ajax({
            url:'__APP__/Goods/getProductSupplier',
            data:'id='+id,
            type:'post',
            dataType:'json',
            success:function(re){
                var supplier_id = '';
                var supplier_name = '';

                $("#product_supplier").empty();
                if(re){
                    for (var k in re){
                        supplier_id = re[k].supplier_id;
                        supplier_name = re[k].supplier_name;
                        
                        var html = "<input type='radio' lay-filter='productSupplierRadio' name='supplier' value='"+supplier_id+"' title='"+supplier_name+"' >";
                        
                        $("#product_supplier").append(html);
                    }
                    layui.form.render('radio')
                }else{
                    $("#product_supplier").append("<span id='sname_notice' style='color:#FF0000;font-size:16px;'> 暂无供应商！</span>");
                }
            }
        });
    });

    form.on('radio(productModelRadio)', function(data){
        console.log(data.elem); //得到radio原始DOM对象
        console.log(data.value); //被点击的radio的value值
        var model_id = data.value;
        var type_id = $("#product_type").val();
        var product_id = $("#product").val();
        if(product_id == ''){
                layer.msg('请先选择商品！', {icon: 5});
                $("#product_type").focus();
                return false;
            }
        if(model_id == ''){
                layer.msg('请先选择商品型号！', {icon: 5});
                $("#product_type").focus();
                return false;
            }
        $.ajax({
            url:'__APP__/Goods/getProductSpecInfos',
            data:'model_id='+model_id+'&product_id='+product_id,
            type:'post',
            dataType:'json',
            success:function(re){
                if(re){
                    var parameter_id = '';
                    var parameter_name = '';
                    var spec_id = '';
                    var spec_value = '';
                    var parameter_id_str = '';
                    $("#model~#product_parameter").remove(); 
                    for (var k in re){
                        parameter_id = re[k].id; 
                        parameter_name = re[k].name;
                        var spec = re[k].spec;
                        if(parameter_id_str){
                            parameter_id_str = parameter_id_str+","+parameter_id+"@"+parameter_name;
                        }else{
                            parameter_id_str = parameter_id+"@"+parameter_name;
                        }
                        var parameter_html = "<div id='product_parameter' class='layui-form-item' style='margin-left:50px;'> <label class='layui-form-label' style='margin-right:50px;'>"+parameter_name+":</label>";
                        var spec_html_one = ''; 
                        if(spec){
                            for ( key in spec){
                                spec_id = spec[key].id;
                                spec_value = spec[key].spec_value;
                                
                                if(spec_html_one){
                                    spec_html_one = spec_html_one+"<input type='radio' lay-filter='productSpecRadio' name='product_spec_"+parameter_id+"' value='"+spec_id+"' title='"+spec_value+"' > ";
                                }else{
                                    spec_html_one ="<input type='radio' lay-filter='productSpecRadio' name='product_spec_"+parameter_id+"' value='"+spec_id+"' title='"+spec_value+"' > ";
                                }
                            }
                        }else{
                            spec_html_one ="<span id='sname_notice' style='color:#FF0000;font-size:16px;'> 请先添加该商品的  "+parameter_name+"  规格数据！</span>";
                        }
                        if(spec_html_one){
                            var spec_html = "<div class='layui-input-block' id='product_spec' lay-filter='product_spec' > "+spec_html_one+" </div> </div> ";
                        }else{
                            var spec_html = "<div class='layui-input-block' id='product_spec' lay-filter='product_spec' >  </div> </div> ";
                        }
                        var html = parameter_html + spec_html;

                        $("#model").after(html);
                    }
                    layui.form.render('radio')
                    //在隐藏域中追加商品规格名称id 组成的字符串
                    var parameter_id_str_html = "<input type='hidden' id='parameter_id' name='parameter_id' value='"+parameter_id_str+"' >";
                    $("#parameter_hidden").append(parameter_id_str_html);
                }else{
                    $("#model~#product_parameter").remove();
                    var null_html = "<div id='product_parameter' class='layui-form-item' style='margin-left:50px;'> <label class='layui-form-label' style='margin-right:50px;'>商品规格:</label><div class='layui-input-block' id='product_spec' lay-filter='product_spec' > <span id='sname_notice' style='color:#FF0000;font-size:16px;'> 暂无商品规格信息！</span>  </div> </div> ";
                    $("#model").after(null_html);
                }
            }
        });
    });
    form.on('radio(productSpecRadio)', function(data){
        console.log(data.elem); //得到radio原始DOM对象
        console.log(data.value); //被点击的radio的value值
        // alert(data.value);
    }); 
});
</script>
<script type="text/javascript">
    function addProductPrice(){
        var powerName = 'addProductPrice';
        $.post("__APP__/Base/isPower",{"powerName":powerName},function(res){
            if(res == 0){
                layer.alert("您暂时没有该操作的权限！",{icon:4,title:"提示"});
                return false;
            }else{
                layui.use('layer', function(){
                var layer = layui.layer;
                //获取隐藏域中商品规格名称id字符串
                var parameter_id = $("#parameter_id").val();
                //商品分类ID
                var product_type = $("#product_type").val();
                //商品名称ID
                var product = $("#product").val();
                if(product == ''){
                    layer.msg('请选择商品名称！', {icon: 5,offset: '200px',});
                    $("#product").focus();
                    return false;
                }
                //商品型号ID
                var product_model = '';
                $('input[name=product_model]').each(function() {
                    if(this.checked) {
                        product_model = $(this).val();
                    }
                });
                if(product_model == ''){
                    layer.msg('请选择商品型号！', {icon: 5,offset: '200px',});
                    $("#product_model").focus();
                    return false;
                }
                //商品规格
                var product_spec = [];
                if(parameter_id){
                    var parameter_id_arr = parameter_id.split(',');
                    // alert(parameter_id_arr[1]);exit;
                    for (key in parameter_id_arr){
                        // var spec_name = 'product_spec_'+parameter_id_arr[key];
                        var parameter_info = parameter_id_arr[key].split('@');
                        var spec = '';

                        // alert(parameter_info[1]);exit;
                        $("input[name=product_spec_"+parameter_info[0]+"]").each(function() {
                            if(this.checked) {
                                spec = parameter_info[0]+"@"+$(this).val();
                            }
                        });

                        if(spec == ''){
                            layer.msg("请选择"+parameter_info[1]+"！", {icon: 5,offset: '200px',});
                            $("#product_model").focus();
                            return false;
                        }else{
                            product_spec.push(spec);
                        }
                        
                    }

                    var product_spec_str = product_spec.join(','); 
                }
                //供应商
                var product_supplier = '';
                $('input[name=supplier]').each(function(){
                    if(this.checked) {
                        product_supplier = $(this).val();
                    }
                });
                if(product_supplier == ''){
                    layer.msg('请选择供应商！', {icon: 5,offset: '200px',});
                    $("#supplier").focus();
                    return false;
                }
                //商品价格
                var product_price = $("#price").val();
                if(product_price == ''){
                    layer.msg('请填写商品价格！', {icon: 5,offset: '200px',});
                    $("#price").focus();
                    return false;
                }
                //验证该商品的价格是否已经添加
                $.ajax({
                    url:'__APP__/Goods/getProductPrice',
                    type:'post',
                    data:'product='+product+'&product_model='+product_model+'&product_spec_str='+product_spec_str+'&product_supplier='+product_supplier+'&product_price='+product_price,
                    dataType:'json',
                    success:function(res){
                        if(res != ''){
                            for( k in res){
                                var product_price_id = res[k].id;
                                var product_price2 = res[k].price;

                                layer.confirm("已有该商品的价格！报价为<span id='sname_notice' style='color:#FF0000;font-size:16px;'> ￥"+product_price2+" </span> 您要修改商品的报价吗？", {
                                    icon: 3,
                                    anim:5,
                                    title:'提示',
                                    btn: ['确定','取消'] //按钮
                                }, function(){
                                    layer.open({
                                        type: 2,
                                        title: '修改商品价格',
                                        area: ['800px', '550px'],
                                        // fixed: false, //不固定
                                        maxmin: true,
                                        // content:'__APP__/Goods/addProductPrice',
                                        content:'__APP__/Goods/updateProductPrice/product_price_id/'+product_price_id+'/product_price/'+product_price,
                                    });
                                });
                            }
                        }else{
                            layer.open({
                                type: 2,
                                title: '添加商品价格',
                                area: ['800px', '550px'],
                                // fixed: false, //不固定
                                maxmin: true,
                                // content:'__APP__/Goods/addProductPrice',
                                content:'__APP__/Goods/addProductPrice/product/'+product+'/product_model/'+product_model+'/product_spec_str/'+product_spec_str+'/product_supplier/'+product_supplier+'/product_price/'+product_price,
                            });
                        }
                    }
                });
            }); 
            }
        });
        
    }

    
</script>

</body>
</html>